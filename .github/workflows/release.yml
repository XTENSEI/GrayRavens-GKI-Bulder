name: Release Build

on:
  workflow_dispatch:
    inputs:
      RUNNER_TYPE:
        description: Choose the runner type for all jobs
        default: 'ubuntu-latest'
        type: choice
        options:
          - 'self-hosted'
          - 'ubuntu-latest'

# Centralized variables for easier management
env:
  KERNEL_NAME: "SuiKernel"
  RELEASE_REPO: "LoggingNewMemory/SuiKernel-Releases"

jobs:
  prepare:
    name: Prepare Release Info
    runs-on: ${{ inputs.RUNNER_TYPE }}
    outputs:
      full_tag: ${{ steps.gen_tag.outputs.FULL_TAG }}
      hsky_version: ${{ steps.gen_tag.outputs.HSKY_VERSION }}
    steps:
      - name: Generate release tag
        id: gen_tag
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Get the latest tag, handle case where no tags exist
          LATEST_TAG=$(gh api repos/$RELEASE_REPO/tags --jq '.[0].name' 2>/dev/null || echo "")

          # Handle case when $LATEST_TAG doesn't contain $KERNEL_NAME or is empty
          if [[ -z "$LATEST_TAG" ]] || ! echo "$LATEST_TAG" | grep -q "$KERNEL_NAME"; then
              FULL_RELEASE_TAG="$KERNEL_NAME-HSKY1"
          else
              # Check if it's already using HSKY format
              if echo "$LATEST_TAG" | grep -q "HSKY"; then
                  # Extract current HSKY number and increment
                  CURRENT_NUM=$(echo "$LATEST_TAG" | sed -n 's/.*HSKY\([0-9]\+\).*/\1/p')
                  NEW_NUM=$((CURRENT_NUM + 1))
                  FULL_RELEASE_TAG="$KERNEL_NAME-HSKY$NEW_NUM"
              else
                  # Convert from old r format to new HSKY format
                  OLD_NUM=$(echo "$LATEST_TAG" | sed -n 's/.*-r\([0-9]\+\).*/\1/p')
                  NEW_NUM=$((OLD_NUM + 1))
                  FULL_RELEASE_TAG="$KERNEL_NAME-HSKY$NEW_NUM"
              fi
          fi

          echo "Full release tag: $FULL_RELEASE_TAG"
          HSKY_VERSION=$(echo "$FULL_RELEASE_TAG" | sed "s/$KERNEL_NAME-//")
          echo "HSKY version: $HSKY_VERSION"

          echo "FULL_TAG=$FULL_RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "HSKY_VERSION=$HSKY_VERSION" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    strategy:
      matrix:
        variant:
          - { name: "Non-KSU", KSU: "None", KSU_SUSFS: "false", KSU_MANUAL_HOOK: "false", LAST_BUILD: "false" }
          - { name: "SUKISU-Only", KSU: "Suki", KSU_SUSFS: "false", KSU_MANUAL_HOOK: "false", LAST_BUILD: "false" }
          - { name: "SUKISU+SuSFS", KSU: "Suki", KSU_SUSFS: "true", KSU_MANUAL_HOOK: "true", LAST_BUILD: "true" }
    name: Build ${{ matrix.variant.name }} variant
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
      STATUS: "RELEASE"
      HSKY_VERSION: ${{ needs.prepare.outputs.hsky_version }}
      RUNNER_TYPE: ${{ inputs.RUNNER_TYPE }}
      KSU: ${{ matrix.variant.KSU }}
      KSU_SUSFS: ${{ matrix.variant.KSU_SUSFS }}
      KSU_MANUAL_HOOK: ${{ matrix.variant.KSU_MANUAL_HOOK }}
      LAST_BUILD: ${{ matrix.variant.LAST_BUILD }}
      BUILD_BOOTIMG: "true"
      TODO: "kernel"

  release:
    name: Create Unified Release
    needs: [build, prepare]
    runs-on: ${{ inputs.RUNNER_TYPE }}
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_files

      - name: Extract variables from info.txt
        run: |
          info_file=$(find release_files -name "info.txt" -type f | head -1)
          if [[ -f "$info_file" ]]; then
            echo "Found info.txt, loading variables."
            while IFS='=' read -r key value; do
              [[ -z "$key" || "$key" =~ ^#.*$ ]] && continue
              echo "$key=$(echo $value | xargs)" >> $GITHUB_ENV
            done < "$info_file"
          else
            echo "Warning: info.txt not found. Using fallback values."
            echo "LINUX_VERSION=5.10" >> $GITHUB_ENV
            echo "SUKISU_VERSION=unknown" >> $GITHUB_ENV
            echo "SUSFS_VERSION=unknown" >> $GITHUB_ENV
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          repository: ${{ env.RELEASE_REPO }}
          name: ${{ needs.prepare.outputs.full_tag }}
          tag_name: ${{ needs.prepare.outputs.full_tag }}
          prerelease: true
          files: release_files/**/*
          body: |
            ## ðŸ“¢ ${{ needs.prepare.outputs.full_tag }} Builds
            -> Linux ${{ env.LINUX_VERSION }} (android12-5.10-lts)
            -> SukiKSU ${{ env.SUKISU_VERSION }}
            -> SUSFS à¶ž ${{ env.SUSFS_VERSION }}
            -> Kakangkuh: 100

            #### âœï¸ Notes
            -> This kernel only for GKI android12-5.10 device
            -> Aduh Kang... Kakangkuh
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Send notification to TG
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          if [[ -n "$TG_BOT_TOKEN" && -n "$TG_CHAT_ID" ]]; then
            MESSAGE="ðŸ“¦ Release completed! [Click](https://github.com/${{ env.RELEASE_REPO }}/releases/tag/${{ needs.prepare.outputs.full_tag }})"
            curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
              -d chat_id="$TG_CHAT_ID" \
              -d text="$MESSAGE" \
              -d parse_mode="Markdown" \
              -d disable_web_page_preview=true || echo "Telegram notification failed, but continuing..."
          else
            echo "Telegram secrets not available, skipping notification"
          fi
